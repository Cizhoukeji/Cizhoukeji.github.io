<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>移动端数控代码生成器</title>
    
    <!-- 引入文件二的CSS和JS资源 -->
    <link rel="stylesheet" href="../css/h5ui.min.css">
    <link rel="stylesheet" href="../css/example.min.css">
    <link rel="stylesheet" type="text/css" href="../css/reset.css">
    <link rel="stylesheet" type="text/css" href="../css/sort.css">
    <link rel="stylesheet" type="text/css" href="../css/animation.css">
    
    <!-- 引入文件二的JS库 -->
    <script src="../js/jquery.min.js"></script>
    <script src="../js/h5ui.min.js"></script>
    <script src="../js/base64.min.js"></script>
    <script src="../js/math.js"></script>
    <script src="../js/jquery.mobile-1.4.5.min.js"></script>
    <script src="../js/zepto.min.js"></script>
    <script src="../js/Sortable.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 14px; /* 添加基础字体大小 */
        }
        
        h1 {
            display: none;
        }
        
        .main-container {
            display: flex;
            flex: 1;
            padding: 5px;
            gap: 5px;
            position: relative;
            overflow: hidden;
        }
        
        .left-panel {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            gap: 5px;
            position: relative;
            min-width: 45%;
        }
        
        .right-panel {
            flex: 2.5;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .fixed-top {
            background: white;
            padding: 10px;
            z-index: 10;
            position: sticky;
            top: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .fixed-bottom {
            background: white;
            padding: 10px;
            position: sticky;
            bottom: 0;
            z-index: 10;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        
        .scrollable-params {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
        }
        
        .param-section {
            display: none;
            background: white;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .param-section.active {
            display: block;
        }
        
        /* 简化代码预览样式 */
        .code-preview {
            flex: 1;
            padding: 10px;
            overflow: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            background: white;
            /* 添加底部内边距，确保内容不被控制按钮遮挡 */
            padding-bottom: 70px;
            font-size: 14px; /* 添加字体大小 */
        }
        
        .button-group {
            display: flex;
            gap: 5px;
            padding: 5px 0;
        }
        
        .button-group button {
            flex: 1;
            border-radius: 4px;
            font-weight: 500;
            font-size: 14px; /* 添加字体大小 */
        }
        
        /* 控制按钮新样式 - 修改位置 */
        .control-buttons-container {
            position: absolute;
            /* 关键修改：向上移动一个按钮的高度 */
            bottom: 30px; /* 原为0 */
            right: 0;
            width: 100%;
            height: 60px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 5px;
            padding: 5px;
            background: white;
            border-top: 1px solid #ddd;
            box-sizing: border-box;
            /* 添加阴影效果 */
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 20;
        }
        
        .control-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border-radius: 5px;
            text-align: center;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px; /* 添加字体大小 */
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-alarm {
            background-color: #e74c3c;
        }
        
        .btn-safety {
            background-color: #f39c12;
        }
        
        .btn-realtime {
            background-color: #3498db;
        }
        
        .btn-pause {
            background-color: #2ecc71;
        }
        
        .btn-continue {
            background-color: #9b59b6;
        }
        
        .btn-stop {
            background-color: #1abc9c;
        }
        
        .placeholder {
            color: #95a5a6;
            text-align: center;
            padding: 30px 15px;
            font-style: italic;
            font-size: 14px; /* 添加字体大小 */
        }
        
        /* 参数组样式 */
        .param-group {
            background: #f8f9fa;
            padding: 10px; /* 减少内边距 */
            margin-bottom: 10px; /* 减少外边距 */
            border-radius: 8px;
        }
        
        .param-group h3 {
            color: #3498db;
            margin-bottom: 10px; /* 减少外边距 */
            padding-bottom: 8px;
            border-bottom: 1px solid #eaeaea;
            font-size: 1.1rem;
        }
        
        /* 输入框样式 */
        .h5ui-form-input {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 8px; /* 减少内边距 */
            background-color: #fff;
            transition: border-color 0.3s;
            font-size: 14px; /* 添加字体大小 */
            height: 32px; /* 设置高度 */
            width: 100%; /* 设置宽度 */
        }
        
        .h5ui-form-input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        /* 按钮样式 */
        .h5ui-btn_primary {
            background-color: #3498db;
            color: white;
            border: none;
        }
        
        .h5ui-btn_danger {
            background-color: #e74c3c;
            color: white;
            border: none;
        }
        
        .h5ui-btn_success {
            background-color: #2ecc71;
            color: white;
            border: none;
        }
        
        .h5ui-btn:hover {
            opacity: 0.9;
        }

        /* 新增上传状态提示样式 */
        .upload-status {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 5px;
            z-index: 1000;
            display: none;
            font-size: 14px; /* 添加字体大小 */
        }
        
        /* 代码预览样式 */
        .code-item {
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px; /* 添加字体大小 */
        }
        
        .code-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px; /* 添加字体大小 */
        }
        
        /* 模板选择框样式 */
        #template {
            width: 100%; /* 设置宽度 */
            height: 40px; /* 设置高度 */
            font-size: 14px; /* 添加字体大小 */
        }
        
        /* IP地址设置区域 */
        .ip-setting {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            background-color: white;
            border-bottom: 1px solid #eee;
            font-size: 14px; /* 添加字体大小 */
        }
        
        .ip-setting label {
            margin-right: 10px;
            white-space: nowrap;
        }
        
        .ip-setting input {
            flex: 1;
            height: 30px; /* 设置高度 */
        }
    </style>
</head>

<body>
    <div class="main-container">
        <!-- 左侧参数面板 -->
        <div class="left-panel">
            <!-- 固定在顶部的模板选择 -->
            <div class="fixed-top">
                <div class="h5ui-form">
                    <div class="h5ui-select">
                        <select id="template">
                            <option value="nc">NC椭圆加工</option>
                            <option value="rectangle">矩形槽加工</option>
                            <option value="custom">盆孔加工</option>
                            <option value="m30">M30</option> <!-- 新增模板 -->
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- 可滚动的参数区域 -->
            <div class="scrollable-params" id="params-container">
                <!-- NC椭圆加工参数 -->
                <div id="ncParams" class="param-section active">
                    <div class="param-group">
                        <h3>椭圆参数</h3>
                        <div class="h5ui-form">
                            <label for="majorDiameter" class="h5ui-form-label">椭圆大径 </label>
                            <input type="number" id="majorDiameter" class="h5ui-form-input" value="25" min="1" step="0.1">
                        </div>
                        <div class="h5ui-form">
                            <label for="minorDiameter" class="h5ui-form-label">椭圆小径 (MM)</label>
                            <input type="number" id="minorDiameter" class="h5ui-form-input" value="19.5" min="1" step="0.1">
                        </div>
                        <div class="h5ui-form">
                            <label for="allowance" class="h5ui-form-label">留余量 (MM)</label>
                            <input type="number" id="allowance" class="h5ui-form-input" value="0" min="0" step="0.1">
                        </div>
                    </div>
                    
                    <div class="param-group">
                        <h3>加工参数</h3>
                        <div class="h5ui-form">
                            <label for="depth" class="h5ui-form-label">工件深度 (MM)</label>
                            <input type="number" id="depth" class="h5ui-form-input" value="-40" step="1" max="-1">
                        </div>
                        <div class="h5ui-form">
                            <label for="stepDepth" class="h5ui-form-label">单次深度 (MM)</label>
                            <input type="number" id="stepDepth" class="h5ui-form-input" value="-1" step="0.1" max="-0.1">
                        </div>
                        <div class="h5ui-form">
                            <label for="toolDiameter" class="h5ui-form-label">刀具直径 (MM)</label>
                            <input type="number" id="toolDiameter" class="h5ui-form-input" value="40" min="1" step="0.1">
                        </div>
                    </div>
                    
                    <div class="param-group">
                        <h3>速度参数</h3>
                        <div class="h5ui-form">
                            <label for="spindleSpeed" class="h5ui-form-label">主轴速度 (RPM)</label>
                            <input type="number" id="spindleSpeed" class="h5ui-form-input" value="1000" min="100">
                        </div>
                        <div class="h5ui-form">
                            <label for="feedRate" class="h5ui-form-label">进给速度 (MM/M)</label>
                            <input type="number" id="feedRate" class="h5ui-form-input" value="1000" min="100">
                        </div>
                        <div class="h5ui-form">
                            <label for="plungeRate" class="h5ui-form-label">下刀速度 (MM/M)</label>
                            <input type="number" id="plungeRate" class="h5ui-form-input" value="500" min="100">
                        </div>
                        <div class="h5ui-form">
                            <label for="safeHeight" class="h5ui-form-label">安全高度 (MM)</label>
                            <input type="number" id="safeHeight" class="h5ui-form-input" value="10" min="1">
                        </div>
                    </div>
                </div>
                
                <!-- 矩形槽加工参数 -->
                <div id="rectangleParams" class="param-section">
                    <div class="param-group">
                        <h3>矩形参数</h3>
                        <div class="h5ui-form">
                            <label for="rectXWidth" class="h5ui-form-label">X宽度 (MM)</label>
                            <input type="number" id="rectXWidth" class="h5ui-form-input" value="20" min="1" step="0.1">
                        </div>
                        <div class="h5ui-form">
                            <label for="rectYWidth" class="h5ui-form-label">Y宽度 (MM)</label>
                            <input type="number" id="rectYWidth" class="h5ui-form-input" value="30" min="1" step="0.1">
                        </div>
                    </div>
                    
                    <div class="param-group">
                        <h3>加工参数</h3>
                        <div class="h5ui-form">
                            <label for="rectDepth" class="h5ui-form-label">槽深度 (MM)</label>
                            <input type="number" id="rectDepth" class="h5ui-form-input" value="-5" step="1" max="-1">
                        </div>
                        <div class="h5ui-form">
                            <label for="rectStepDepth" class="h5ui-form-label">每层深度 (MM)</label>
                            <input type="number" id="rectStepDepth" class="h5ui-form-input" value="-0.2" step="0.1" max="-0.1">
                        </div>
                        <div class="h5ui-form">
                            <label for="rectToolDiameter" class="h5ui-form-label">刀具直径 (MM)</label>
                            <input type="number" id="rectToolDiameter" class="h5ui-form-input" value="6" min="1" step="0.1">
                        </div>
                    </div>
                    
                    <div class="param-group">
                        <h3>速度参数</h3>
                        <div class="h5ui-form">
                            <label for="rectFeedRate" class="h5ui-form-label">进给速度 (MM/M)</label>
                            <input type="number" id="rectFeedRate" class="h5ui-form-input" value="800" min="100">
                        </div>
                        <div class="h5ui-form">
                            <label for="rectSpindleSpeed" class="h5ui-form-label">主轴转速 (RPM)</label>
                            <input type="number" id="rectSpindleSpeed" class="h5ui-form-input" value="1000" min="100">
                        </div>
                        <div class="h5ui-form">
                            <label for="rectSafeHeight" class="h5ui-form-label">安全高度 (MM)</label>
                            <input type="number" id="rectSafeHeight" class="h5ui-form-input" value="5" min="1">
                        </div>
                        <div class="h5ui-form">
                            <label for="rectStartHeight" class="h5ui-form-label">下刀起点 (MM)</label>
                            <input type="number" id="rectStartHeight" class="h5ui-form-input" value="0" step="0.1">
                        </div>
                    </div>
                </div>
                
                <!-- 盆孔加工参数 -->
                <div id="customParams" class="param-section">
                    <div class="param-group">
                        <h3>位置参数</h3>
                        <div class="h5ui-form">
                            <label for="param1" class="h5ui-form-label">X轴起点 (MM)</label>
                            <input type="number" id="param1" class="h5ui-form-input" value="40" step="0.1">
                        </div>
                        <div class="h5ui-form">
                            <label for="param2" class="h5ui-form-label">Y轴起点 (MM)</label>
                            <input type="number" id="param2" class="h5ui-form-input" value="110" step="0.1">
                        </div>
                        <div class="h5ui-form">
                            <label for="param11" class="h5ui-form-label">X方向偏移 (MM)</label>
                            <input type="number" id="param11" class="h5ui-form-input" value="-8" step="0.1">
                        </div>
                        <div class="h5ui-form">
                            <label for="param12" class="h5ui-form-label">Y方向偏移 (MM)</label>
                            <input type="number" id="param12" class="h5ui-form-input" value="-2" step="0.1">
                        </div>
                        <div class="h5ui-form">
                            <label for="param13" class="h5ui-form-label">A轴修正 (度)</label>
                            <input type="number" id="param13" class="h5ui-form-input" value="0" step="0.1">
                        </div>
                    </div>
                    
                    <div class="param-group">
                        <h3>尺寸参数</h3>
                        <div class="h5ui-form">
                            <label for="param3" class="h5ui-form-label">盆孔长度 (MM)</label>
                            <input type="number" id="param3" class="h5ui-form-input" value="300" step="0.1">
                        </div>
                        <div class="h5ui-form">
                            <label for="param4" class="h5ui-form-label">盆孔宽度 (MM)</label>
                            <input type="number" id="param4" class="h5ui-form-input" value="300" step="0.1">
                        </div>
                        <div class="h5ui-form">
                            <label for="param5" class="h5ui-form-label">R角半径 (MM)</label>
                            <input type="number" id="param5" class="h5ui-form-input" value="10" step="0.1">
                        </div>
                        <div class="h5ui-form">
                            <label for="param10" class="h5ui-form-label">刀口一半 (MM)</label>
                            <input type="number" id="param10" class="h5ui-form-input" value="10" step="0.1">
                        </div>
                    </div>
                    
                    <div class="param-group">
                        <h3>刀具与速度</h3>
                        <div class="h5ui-form">
                            <label for="param7" class="h5ui-form-label">刀片厚度 (MM)</label>
                            <input type="number" id="param7" class="h5ui-form-input" value="3" step="0.1">
                        </div>
                        <div class="h5ui-form">
                            <label for="param6" class="h5ui-form-label">切割速度 (MM/M)</label>
                            <input type="number" id="param6" class="h5ui-form-input" value="3000" min="100">
                        </div>
                        <div class="h5ui-form">
                            <label for="param9" class="h5ui-form-label">下切速度 (MM/M)</label>
                            <input type="number" id="param9" class="h5ui-form-input" value="200" min="100">
                        </div>
                        <div class="h5ui-form">
                            <label for="param8" class="h5ui-form-label">抬刀高度 (MM)</label>
                            <input type="number" id="param8" class="h5ui-form-input" value="30" min="1">
                        </div>
                    </div>
                </div>
                
                <!-- 新增M30参数区域 -->
                <div id="m30Params" class="param-section">
                    <div class="param-group">
                        <h3>自定义指令</h3>
                        <div class="h5ui-form">
                        <label for="param1" class="h5ui-form-label">自定义代码</label>
                            <input type="number" id="param1" class="h5ui-form-input" value="M30" min="1">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 固定在底部的按钮和文件名输入 -->
            <div class="fixed-bottom">
                <div class="h5ui-form">
                    <input type="text" id="filename" class="h5ui-form-input" placeholder="S.nc">
                </div>
                <div class="button-group">
                    <button id="generateBtn" class="h5ui-btn h5ui-btn_primary">生成代码</button>
                    <button id="deleteBtn" class="h5ui-btn h5ui-btn_danger">清空</button>
                    <button id="downloadBtn" class="h5ui-btn h5ui-btn_primary">下载</button>
                    <button id="executeBtn" class="h5ui-btn h5ui-btn_success">执行</button>
                </div>
            </div>
        </div>
        
        <!-- 右侧代码预览 -->
        <div class="right-panel">
            <!-- IP地址设置 -->
            <div class="ip-setting">
                <label for="deviceIP">设备IP:</label>
                <input type="text" id="deviceIP" class="h5ui-form-input" value="192.168.1.69" placeholder="设备IP地址">
            </div>
            
            <div id="codePreview" class="code-preview">
                <div class="placeholder">
                    选择模板并设置参数，点击"生成代码"开始
                </div>
            </div>
            
            <!-- 控制按钮容器 - 位置已上移 -->
            <div class="control-buttons-container">
               
                <div class="control-btn btn-continue" onclick="jixuCode()" oncontextmenu="return false;">继续</div>
                <div class="control-btn btn-safety" onclick="aqzantingCode()" oncontextmenu="return false;">安全暂停</div>
                <div class="control-btn btn-stop" onclick="jieshuCode()" oncontextmenu="return false;">结束</div>
                <div class="control-btn btn-alarm" onclick="jiechuCode()" oncontextmenu="return false;">解除报警</div>
                <div class="control-btn btn-pause" onclick="zantingCode()" oncontextmenu="return false;">暂停</div>
                <div class="control-btn btn-realtime" onclick="sszlCode()" oncontextmenu="return false;">实时指令</div>
                
            </div>
        </div>
    </div>
    
    <!-- 上传状态提示 -->
    <div id="uploadStatus" class="upload-status"></div>

    <script>
        // 文件二的命令发送函数
        function sendCommand(command) {
            const deviceIP = document.getElementById('deviceIP').value;
            const encodedCommand = encodeURIComponent(command);
            const url = `http://${deviceIP}/command?commandText=${encodedCommand}`;
            
            fetch(url, { mode: 'no-cors' })
                .then(() => console.log(`命令发送成功: ${command}`))
                .catch(error => console.error(`发送失败: ${error}`));
        }

        // 暂停命令
        function zantingCode() {
            sendCommand("!");
            console.log("发送暂停命令: !");
            showUploadStatus('发送暂停指令: !', true);
        }

        // 安全暂停命令
        function aqzantingCode() {
            sendCommand("\u0084");
            console.log("发送暂停命令: \\u0084");
            showUploadStatus('发送安全暂停指令: \\u0084', true);
        }

        // 解除报警命令
        function jiechuCode() {
            sendCommand("\u0024X");
            console.log("发送暂停命令: \\u0024X");
            showUploadStatus('发送解除报警指令: \\u0024X', true);
        }

        // 继续命令
        function jixuCode() {
            sendCommand("~");
            console.log("发送继续命令: ~");
            showUploadStatus('发送继续指令: ~', true);
        }

        // 结束命令
        function jieshuCode() {
            sendCommand("\u0018");
            console.log("发送结束命令: CAN (\\u0018)");
            showUploadStatus('发送结束指令: CAN (\\u0018)', true);
        }

        // 实时指令界面
        function sszlCode() {
            window.location.href = "file:///android_asset/dist/static/gcodeh/index.html";
            console.log("跳转到预览界面");
        }

        // 显示上传状态
        function showUploadStatus(message, isSuccess) {
            const statusElement = document.getElementById('uploadStatus');
            statusElement.textContent = message;
            statusElement.style.backgroundColor = isSuccess ? 'rgba(0,128,0,0.7)' : 'rgba(255,0,0,0.7)';
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        // 保存文件到本地
        async function saveFileToLocal(filename, content) {
            try {
                // 尝试使用FileSystem API
                if ('showSaveFilePicker' in window) {
                    const options = {
                        suggestedName: filename,
                        types: [{
                            description: 'Text Files',
                            accept: {'text/plain': ['.txt']}
                        }]
                    };
                    
                    const handle = await window.showSaveFilePicker(options);
                    const writable = await handle.createWritable();
                    await writable.write(content);
                    await writable.close();
                    return true;
                }
                
                // 回退方案：使用下载方式
                const blob = new Blob([content], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                return true;
            } catch (error) {
                console.error('保存文件失败:', error);
                return false;
            }
        }

        // 上传文件到局域网设备
        async function uploadToLocalNetwork(filename, content) {
            try {
                showUploadStatus('正在上传文件...', false);
                
                // 创建FormData对象
                const formData = new FormData();
                const blob = new Blob([content], { type: 'text/plain' });
                
                // 添加文件到FormData
                formData.append('myfile', blob, `${filename}.TXT`);
                formData.append('path', '/');
                formData.append('filename', filename);
                
                // 获取设备IP
                const deviceIP = document.getElementById('deviceIP').value;
                
                // 发送请求到局域网设备
                const response = await fetch(`http://${deviceIP}/upload`, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors'
                });
                
                showUploadStatus('文件上传成功', true);
                return true;
            } catch (error) {
                console.error('上传失败:', error);
                showUploadStatus('上传失败: ' + error.message, false);
                return false;
            }
        }

        // 文件一的功能实现
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const templateSelect = document.getElementById('template');
            const generateBtn = document.getElementById('generateBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const executeBtn = document.getElementById('executeBtn'); // 新增执行按钮
            const filenameInput = document.getElementById('filename');
            const codePreview = document.getElementById('codePreview');
            const deviceIPInput = document.getElementById('deviceIP');
            
            // 参数部分
            const ncParams = document.getElementById('ncParams');
            const rectangleParams = document.getElementById('rectangleParams');
            const customParams = document.getElementById('customParams');
            const m30Params = document.getElementById('m30Params'); // 新增
            
            // 设置默认值
            document.getElementById('depth').value = -40;
            document.getElementById('stepDepth').value = -1;
            document.getElementById('rectDepth').value = -5;
            document.getElementById('rectStepDepth').value = -0.2;
            
            // 自动保存功能
            const inputs = document.querySelectorAll('input, select');
            const saveTime = 6000; // 6秒自动保存
            
            inputs.forEach(input => {
                // 恢复保存的值
                const savedValue = localStorage.getItem(input.id);
                if (savedValue !== null) {
                    input.value = savedValue;
                }
                
                // 设置定时器变量
                let timer;
                
                input.addEventListener('input', function() {
                    // 清除之前的定时器
                    clearTimeout(timer);
                    // 设置新的定时器
                    timer = setTimeout(() => {
                        localStorage.setItem(input.id, input.value);
                        console.log(`自动保存: ${input.id} = ${input.value}`);
                    }, saveTime);
                });
            });
            
            // 为IP输入框添加自动保存
            deviceIPInput.addEventListener('blur', function() {
                localStorage.setItem('deviceIP', this.value);
                console.log(`保存设备IP: ${this.value}`);
            });
            
            // 模板选择变化事件
            templateSelect.addEventListener('change', function() {
                // 隐藏所有参数部分
                ncParams.classList.remove('active');
                rectangleParams.classList.remove('active');
                customParams.classList.remove('active');
                m30Params.classList.remove('active'); // 新增
                
                // 显示选中的参数部分
                if (this.value === 'nc') {
                    ncParams.classList.add('active');
                } else if (this.value === 'rectangle') {
                    rectangleParams.classList.add('active');
                } else if (this.value === 'custom') {
                    customParams.classList.add('active');
                } else if (this.value === 'm30') {
                    m30Params.classList.add('active');
                }
            });
            
            // 生成代码按钮事件
            generateBtn.addEventListener('click', function() {
                const template = templateSelect.value;
                let code = '';
                let title = '';
                
                if (template === 'nc') {
                    code = generateNCCode();
                    title = 'NC椭圆加工代码';
                } else if (template === 'rectangle') {
                    code = generateRectangleCode();
                    title = '矩形槽加工代码';
                } else if (template === 'custom') {
                    code = generateCustomCode();
                    title = '盆孔加工代码';
                } else if (template === 'm30') {
                    code = "M30";
                    title = '自定义指令';
                }
                
                // 添加生成的代码到预览区
                addCodeToPreview(title, code);
            });
            
            // 删除代码按钮事件
            deleteBtn.addEventListener('click', function() {
                if (confirm('确定要清空所有生成的代码吗？')) {
                    codePreview.innerHTML = '<div class="placeholder">选择模板并设置参数，点击"生成代码"开始</div>';
                }
            });
            
            // 下载代码按钮事件 - 修改后版本
            downloadBtn.addEventListener('click', async function() {
                const code = getAllGeneratedCode();
                let filename = filenameInput.value || 'S.nc';
                
                // 确保文件名有.nc扩展名
                if (!filename.toLowerCase().endsWith('.nc')) {
                    filename += '.nc';
                }
                
                if (!code) {
                    alert('没有可下载的代码');
                    return;
                }
                
                try {
                    // 1. 保存到本地
                    const saveSuccess = await saveFileToLocal(filename, code);
                    if (!saveSuccess) {
                        throw new Error('保存文件失败');
                    }
                    
                    // 2. 询问是否上传到局域网设备
                    const confirmUpload = confirm('文件已保存到本地，是否要上传到局域网设备？');
                    if (confirmUpload) {
                        // 获取设备IP
                        const deviceIP = deviceIPInput.value;
                        if (deviceIP) {
                            // 3. 上传到局域网设备
                            const uploadSuccess = await uploadToLocalNetwork(filename.replace('.nc', ''), code);
                            if (!uploadSuccess) {
                                throw new Error('上传失败');
                            }
                        }
                    }
                } catch (error) {
                    console.error('操作失败:', error);
                    alert('操作失败: ' + error.message);
                }
            });
            
            // 执行按钮事件
            executeBtn.addEventListener('click', function() {
                let filename = filenameInput.value.trim();
                
                // 如果文件名为空，使用默认文件名
                if (!filename) {
                    filename = 'S.nc';
                }
                
                // 移除文件扩展名（如果有）
                const baseFilename = filename.split('.')[0];
                
                // 获取设备IP
                const deviceIP = deviceIPInput.value;
                
                // 构造命令
                const command = `[ESP220]/${baseFilename}.TXT`;
                
                // 发送命令
                sendCommand(command);
                
                // 显示执行状态
                showUploadStatus(`正在执行: ${baseFilename}`, true);
                console.log(`执行命令: ${command}`);
            });
            
            // 生成NC代码
            function generateNCCode() {
                // 获取用户输入
                const majorDiameter = parseFloat(document.getElementById('majorDiameter').value);
                const minorDiameter = parseFloat(document.getElementById('minorDiameter').value);
                const depth = parseFloat(document.getElementById('depth').value);
                const stepDepth = parseFloat(document.getElementById('stepDepth').value);
                const spindleSpeed = parseInt(document.getElementById('spindleSpeed').value);
                const feedRate = parseInt(document.getElementById('feedRate').value);
                const plungeRate = parseInt(document.getElementById('plungeRate').value);
                const toolDiameter = parseFloat(document.getElementById('toolDiameter').value);
                const safeHeight = parseFloat(document.getElementById('safeHeight').value);
                const allowance = parseFloat(document.getElementById('allowance').value);
                
                // 计算刀具半径
                const toolRadius = toolDiameter / 2;
                
                // 计算椭圆半径（含补偿）
                const radiusX = (majorDiameter / 2) + toolRadius + allowance;
                const radiusY = (minorDiameter / 2) + toolRadius + allowance;
                
                // 计算层数
                const layers = Math.ceil(Math.abs(depth) / Math.abs(stepDepth));
                
                // 生成G代码
                let gcode = `%%\n`;
                gcode += `O1000 (椭圆加工程序)\n`;
                gcode += `(创建时间: ${new Date().toLocaleString()})\n`;
                gcode += `(椭圆参数: 大径${majorDiameter}mm 小径${minorDiameter}mm)\n`;
                gcode += `(加工参数: 深度${depth}mm 刀具Ø${toolDiameter}mm)\n\n`;
                gcode += `(系统初始化)\n`;
                gcode += `G90 G80 G40 G49 G17\n`;
                gcode += `G91 G28 Z0\n`;
                gcode += `G90\n\n`;
                gcode += `(启动加工)\n`;
                gcode += `M3 S${spindleSpeed}\n`;
                gcode += `G4 P3.0\n`;
                gcode += `G0 G54 X${radiusX.toFixed(3)} Y0\n`;
                gcode += `G43 H1 Z${safeHeight.toFixed(1)}\n`;
                gcode += `M8\n`;
                gcode += `G0 Z2.0\n\n`;
                
                // 生成路径点
                for(let layer = 0; layer <= layers; layer++) {
                    const currentDepth = Math.max(depth, layer * stepDepth);
                    
                    gcode += `(层切: ${currentDepth.toFixed(1)}mm)\n`;
                    gcode += `G1 Z${currentDepth.toFixed(3)} F${plungeRate}\n`;
                    gcode += `F${feedRate}\n`;
                    
                    for(let angle = 0; angle <= 360; angle += 5) {
                        const rad = angle * Math.PI / 180;
                        const x = radiusX * Math.cos(rad);
                        const y = radiusY * Math.sin(rad);
                        
                        gcode += `X${x.toFixed(3)} Y${y.toFixed(3)}\n`;
                    }
                    
                    gcode += '\n';
                }
                
                // 程序结束
                gcode += `(程序结束)\n`;
                gcode += `G0 Z${safeHeight.toFixed(1)}\n`;
                gcode += `G91 G28 Z0\n`;
                gcode += `G90\n`;
                gcode += `G91 G28 Y0\n`;
                gcode += `M5\n`;
                gcode += `M9\n`;
                gcode += `M30\n`;
                gcode += `%%`;
                
                return gcode;
            }
            
            // 生成矩形槽宏程序代码
            function generateRectangleCode() {
                // 获取用户输入
                const xWidth = parseFloat(document.getElementById('rectXWidth').value);
                const yWidth = parseFloat(document.getElementById('rectYWidth').value);
                const depth = parseFloat(document.getElementById('rectDepth').value);
                const stepDepth = parseFloat(document.getElementById('rectStepDepth').value);
                const feedRate = parseInt(document.getElementById('rectFeedRate').value);
                const spindleSpeed = parseInt(document.getElementById('rectSpindleSpeed').value);
                const safeHeight = parseFloat(document.getElementById('rectSafeHeight').value);
                const startHeight = parseFloat(document.getElementById('rectStartHeight').value);
                const toolDiameter = parseFloat(document.getElementById('rectToolDiameter').value);
                
                // 计算刀具半径
                const toolRadius = toolDiameter / 2;
                
                // 计算实际加工尺寸（减去刀具半径）
                const xHalf = (xWidth / 2) - toolRadius;
                const yHalf = (yWidth / 2) - toolRadius;
                
                // 计算层数
                const layers = Math.ceil(Math.abs(depth - startHeight) / Math.abs(stepDepth));
                
                // 生成G代码
                let gcode = `%%\n`;
                gcode += `O2000 (矩形槽加工程序)\n`;
                gcode += `(创建时间: ${new Date().toLocaleString()})\n`;
                gcode += `(矩形参数: X${xWidth}mm Y${yWidth}mm)\n`;
                gcode += `(加工参数: 深度${depth}mm 刀具Ø${toolDiameter}mm)\n\n`;
                gcode += `(系统初始化)\n`;
                gcode += `G90 G80 G40 G49 G17\n`;
                gcode += `G91 G28 Z0\n`;
                gcode += `G90\n\n`;
                gcode += `(启动加工)\n`;
                gcode += `M3 S${spindleSpeed}\n`;
                gcode += `G4 P3.0\n`;
                gcode += `G0 G54 X0 Y0\n`;
                gcode += `G43 H1 Z${safeHeight.toFixed(1)}\n`;
                gcode += `M8\n\n`;
                gcode += `(移动到起始位置)\n`;
                gcode += `G0 X${xHalf.toFixed(3)} Y${yHalf.toFixed(3)}\n`;
                gcode += `G0 Z2.0\n\n`;
                
                // 生成加工路径
                for(let layer = 0; layer <= layers; layer++) {
                    const currentDepth = startHeight + (layer * stepDepth);
                    const finalDepth = Math.max(depth, currentDepth);
                    
                    gcode += `(层切: ${finalDepth.toFixed(1)}mm)\n`;
                    gcode += `G1 Z${finalDepth.toFixed(3)} F${feedRate/2}\n`;
                    gcode += `F${feedRate}\n`;
                    
                    gcode += `G1 Y${(-yHalf).toFixed(3)}\n`;
                    gcode += `G1 X${(-xHalf).toFixed(3)}\n`;
                    gcode += `G1 Y${yHalf.toFixed(3)}\n`;
                    gcode += `G1 X${xHalf.toFixed(3)}\n\n`;
                }
                
                // 程序结束
                gcode += `(程序结束)\n`;
                gcode += `G0 Z${safeHeight.toFixed(1)}\n`;
                gcode += `G91 G28 Z0\n`;
                gcode += `G90\n`;
                gcode += `G91 G28 Y0\n`;
                gcode += `M5\n`;
                gcode += `M9\n`;
                gcode += `M30\n`;
                gcode += `%%`;
                
                return gcode;
            }
            
            // 生成盆孔加工宏程序代码
            function generateCustomCode() {
                // 获取用户输入
                const p1 = parseFloat(document.getElementById('param1').value);
                const p2 = parseFloat(document.getElementById('param2').value);
                const p3 = parseFloat(document.getElementById('param3').value);
                const p4 = parseFloat(document.getElementById('param4').value);
                const p5 = parseFloat(document.getElementById('param5').value);
                const p6 = parseFloat(document.getElementById('param6').value);
                const p7 = parseFloat(document.getElementById('param7').value);
                const p8 = parseFloat(document.getElementById('param8').value);
                const p9 = parseFloat(document.getElementById('param9').value);
                const p10 = parseFloat(document.getElementById('param10').value);
                const p11 = parseFloat(document.getElementById('param11').value);
                const p12 = parseFloat(document.getElementById('param12').value);
                const p13 = parseFloat(document.getElementById('param13').value);
                
                // 生成G代码
                let gcode = `%%\n`;
                gcode += `O3000 (盆孔加工程序)\n`;
                gcode += `(创建时间: ${new Date().toLocaleString()})\n`;
                gcode += `(盆孔参数: X起点${p1} Y起点${p2} 长度${p3} 宽度${p4})\n`;
                gcode += `(R角${p5} 刀具厚度${p7} 刀口半宽${p10})\n\n`;
                gcode += `(系统初始化)\n`;
                gcode += `G90 G80 G40 G49 G17\n`;
                gcode += `G91 G28 Z0\n`;
                gcode += `G90\n\n`;
                gcode += `(启动加工)\n`;
                gcode += `M3\n`;
                gcode += `G90 G1 A0 F12000\n`;
                gcode += `Z${p8}\n`;
                gcode += `C0\n`;
                gcode += `X${(p1 + p5 - p10).toFixed(3)} Y-${p2}\n`;
                gcode += `G91 G1 X${p11}\n`;
                gcode += `Z-${p8} F${p9}\n`;
                gcode += `X${(p3 - 2*p5 - 2*p10).toFixed(3)} F${p6}\n`;
                gcode += `Z${p8} F12000\n`;
                gcode += `X-${(p3 - 2*p5 - 2*p10).toFixed(3)}\n`;
                gcode += `Y-${(p4 - p7).toFixed(3)}\n`;
                gcode += `Z-${p8} F${p9}\n`;
                gcode += `X${(p3 - 2*p5 - 2*p10).toFixed(3)} F${p6}\n`;
                gcode += `Z${p8} F12000\n`;
                gcode += `G90 G1 X${p1} Y-${(p2 + p5 + 3*p10).toFixed(3)} A${p13} C-90\n`;
                gcode += `G91 G1 Y${p12}\n`;
                gcode += `Z-${p8} F${p9}\n`;
                gcode += `Y-${(p4 - 2*p5 - 2*p10).toFixed(3)} F${p6}\n`;
                gcode += `Z${p8} F12000\n`;
                gcode += `Y${(p4 - 2*p5 - 2*p10).toFixed(3)}\n`;
                gcode += `X${(p3 - p7).toFixed(3)}\n`;
                gcode += `Z-${p8} F${p9}\n`;
                gcode += `Y-${(p4 - 2*p5 - 2*p10).toFixed(3)} F${p6}\n`;
                gcode += `Z${p8} F12000\n\n`;
                gcode += `(程序结束)\n`;
                gcode += `G91 G28 Z0\n`;
                gcode += `G90\n`;
                gcode += `G91 G28 Y0\n`;
                gcode += `M5\n`;
                gcode += `M30\n`;
                gcode += `%%`;
                
                return gcode;
            }
            
            // 添加代码到预览区
            function addCodeToPreview(title, code) {
                // 移除占位符（如果存在）
                const placeholder = codePreview.querySelector('.placeholder');
                if (placeholder) {
                    codePreview.removeChild(placeholder);
                }
                
                // 创建代码项
                const codeItem = document.createElement('div');
                codeItem.className = 'code-item';
                
                const now = new Date();
                const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                
                codeItem.innerHTML = `
                    <div class="code-item-header">
                        <span>${title}</span>
                        <span>${timeString}</span>
                    </div>
                    <div>${code}</div>
                `;
                
                // 添加到预览区顶部
                codePreview.prepend(codeItem);
            }
            
            // 获取所有生成的代码
            function getAllGeneratedCode() {
                const codeItems = codePreview.querySelectorAll('.code-item');
                if (codeItems.length === 0) return '';
                
                let allCode = '';
                
                // 倒序添加（因为预览区是后生成的在上方）
                for (let i = codeItems.length - 1; i >= 0; i--) {
                    const title = codeItems[i].querySelector('.code-item-header span:first-child').textContent;
                    const content = codeItems[i].querySelector('div:last-child').textContent;
                    allCode += `; ${title}\n${content}\n\n`;
                }
                
                return allCode;
            }
        });
    </script>
</body>
</html>